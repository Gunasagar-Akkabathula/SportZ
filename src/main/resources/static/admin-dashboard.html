<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard - Shop</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .navbar-brand { font-weight: bold; font-size: 1.8rem; color: #ff6600 !important; display: flex; align-items: center; }
    .navbar-brand img { height: 80px; margin-right: 8px; border-radius: 50%; }
    .navbar-nav { gap: 18px; }
    .search-input, .navbar form .form-control { min-width: 220px; width: 100%; }
    .product-form { max-width: 450px; margin: 40px auto 20px auto; }
    .product-form label { display: block; margin-bottom: 5px; font-weight: bold;}
    .product-form input, .product-form textarea, .product-form select {
      width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px;
    }
    .product-form button { padding: 10px 16px; background: #ef6c00; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .product-form button:hover { background: #bd5300; }
    .product-card img { max-height: 120px; object-fit: contain; margin-bottom: 6px; }
    .product-card { box-shadow: 0 1px 8px rgba(0,0,0,.06); border-radius: 8px; padding: 18px; margin-bottom: 18px;}
    .product-actions { margin-top: 12px;}
    .product-actions button {margin-right: 10px;}
    #editProductModal .modal-dialog {max-width: 400px;}
    .modal-backdrop.show {opacity: 0.18;}
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="#">
      <img src="SportZ.jpg" >
      <span class="ms-2">SportZ</span>
    </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <form class="d-flex mx-auto w-50" role="search" id="search-form">
          <input class="form-control me-2 search-input" type="search" placeholder="Search products, brands and more" aria-label="Search" id="search-input" />
          <button class="btn btn-warning" type="submit">Search</button>
        </form>
        <ul class="navbar-nav ms-auto align-items-center" id="dynamic-navbar-links"></ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <h2 class="mt-4 mb-2">Admin Dashboard</h2>
    <!-- Add Product form -->
    <div class="product-form card p-4" id="add-product-section">
      <h4 class="mb-3">Add Product</h4>
      <form id="product-form">
        <label for="product-category">Category</label>
        <select id="product-category" required>
          <option value="">Choose a category</option>
        </select>

        <label for="product-name">Product Name</label>
        <input type="text" id="product-name" required>

        <label for="product-desc">Description</label>
        <textarea id="product-desc" rows="2"></textarea>

        <label for="product-price">Price</label>
        <input type="number" id="product-price" step="0.01" required>

        <label for="product-image">Image URL</label>
        <input type="text" id="product-image" required>

        <button type="submit">Add Product</button>
      </form>
    </div>

    <!-- Products List -->
    <h4 class="mt-5 mb-3">All Products</h4>
    <div id="products-grid"></div>
  </div>

  <!-- Edit Product Modal -->
  <div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="edit-product-form">
        <div class="modal-header"><h5 class="modal-title" id="editProductLabel">Edit Product</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="edit-product-id" />

          <label for="edit-product-category">Category</label>
          <select id="edit-product-category" required>
            <option value="">Choose a category</option>
          </select>

          <label for="edit-product-name">Product Name</label>
          <input type="text" id="edit-product-name" required />

          <label for="edit-product-desc">Description</label>
          <textarea id="edit-product-desc" rows="2"></textarea>

          <label for="edit-product-price">Price</label>
          <input type="number" id="edit-product-price" step="0.01" required />

          <label for="edit-product-image">Image URL</label>
          <input type="text" id="edit-product-image" required />
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function renderNavbar() {
      const navbarLinks = document.getElementById('dynamic-navbar-links');
      navbarLinks.innerHTML = '';
      const adminEmail = localStorage.getItem('adminEmail');
      const adminName = localStorage.getItem('adminName');
      if (adminEmail) {
        navbarLinks.innerHTML = `
          <li class="nav-item"><a class="nav-link" href="admin-dashboard.html">Products</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              ${adminName || "Admin"}
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
              <li><a class="dropdown-item" href="admin-dashboard.html">My Profile</a></li>
              <li><a class="dropdown-item" href="#" onclick="logout()">Logout</a></li>
            </ul>
          </li>
        `;
      } else {
        navbarLinks.innerHTML = `
          <li class="nav-item"><a class="nav-link" href="sign-in.html">Sign In</a></li>
          <li class="nav-item"><a class="nav-link" href="index.html">Products</a></li>
          <li class="nav-item"><a class="nav-link" href="cart.html">Cart</a></li>
          <li class="nav-item"><a class="nav-link" href="sign-up.html">Sign Up</a></li>
        `;
      }
    }
    
    function logout() {
      localStorage.clear();
      window.location.href = "index.html";
    }

    // Load categories into dropdown for product addition and edit
    async function loadCategoriesToDropdown(dropdownId) {
        const select = document.getElementById(dropdownId);
        if (!select) return;
        select.innerHTML = '<option value="">Choose a category</option>';
        try {
            const res = await fetch('/api/categories');
            if (res.ok) {
                const categories = await res.json();
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.categoryName;
                    select.appendChild(option);
                });
            }
        } catch (e) {
            alert('Could not load categories');
        }
    }

    // Add Product
    document.getElementById("product-form").addEventListener("submit", async function(e) {
        e.preventDefault();
        const adminEmail = localStorage.getItem('adminEmail');
        const product = {
          name: document.getElementById('product-name').value,
          description: document.getElementById('product-desc').value,
          price: document.getElementById('product-price').value,
          imageUrl: document.getElementById('product-image').value,
          category: { id: document.getElementById('product-category').value }
        };
        const res = await fetch('/products?adminEmail=' + encodeURIComponent(adminEmail), {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(product)
        });
        if (res.ok) {
          alert('Product added!');
          document.getElementById('product-form').reset();
          loadProducts();
        } else {
          alert('Add product failed: ' + await res.text());
        }
    });

    // Load Products with optional search
    async function loadProducts(searchQuery = '') {
      const grid = document.getElementById("products-grid");
      let url = '/products';
      
      if (searchQuery && searchQuery.trim() !== '') {
        url = `/products/search?query=${encodeURIComponent(searchQuery.trim())}`;
      }
      
      const res = await fetch(url);
      if (res.ok) {
        const products = await res.json();
        grid.innerHTML = '';
        
        if (products.length === 0) {
          grid.innerHTML = '<p class="text-center text-muted">No products found.</p>';
          return;
        }
        
        products.forEach(product => {
          grid.innerHTML += `
            <div class="product-card row align-items-center">
              <div class="col-md-3 col-12">
                <img src="${product.imageUrl || 'https://via.placeholder.com/140x140.png?text=No+Image'}" alt="${product.name}" />
              </div>
              <div class="col-md-6 col-12">
                <h5>${product.name}</h5>
                <div>${product.description || ''}</div>
                <div class="text-danger fw-bold mt-1">â‚¹${product.price}</div>
              </div>
              <div class="col-md-3 col-12 product-actions">
                <button class="btn btn-outline-success btn-sm" onclick="showEditModal(${product.id}, '${escapeQuotes(product.name)}', '${escapeQuotes(product.description)}', '${product.price}', '${escapeQuotes(product.imageUrl)}')">Edit</button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteProduct(${product.id})">Delete</button>
              </div>
            </div>
          `;
        });
      }
    }

    function escapeQuotes(str) {
      if (!str) return '';
      return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }

    // Edit Product
    window.showEditModal = function(id, name, desc, price, imageUrl) {
      document.getElementById("edit-product-id").value = id;
      document.getElementById("edit-product-name").value = unescapeQuotes(name);
      document.getElementById("edit-product-desc").value = unescapeQuotes(desc);
      document.getElementById("edit-product-price").value = price;
      document.getElementById("edit-product-image").value = unescapeQuotes(imageUrl);
      
      // Load categories for edit dropdown and select current
      loadCategoriesToDropdown('edit-product-category').then(() => {
        document.getElementById('edit-product-category').value = window.currentEditingCategoryId;
      });
      
      const editModal = new bootstrap.Modal(document.getElementById('editProductModal'));
      
      // Store current category id globally
      fetch(`/products/${id}`).then(res => res.json()).then(prod => {
        window.currentEditingCategoryId = prod.category ? prod.category.id : "";
        document.getElementById('edit-product-category').value = window.currentEditingCategoryId;
      });
      
      editModal.show();
    };

    // Unescape quotes utility
    function unescapeQuotes(str) {
      if (!str) return '';
      return str.replace(/\\'/g, "'").replace(/&quot;/g, '"');
    }

    // Save Edit Product
    document.getElementById("edit-product-form").addEventListener("submit", async function(e) {
      e.preventDefault();
      const adminEmail = localStorage.getItem('adminEmail');
      const id = document.getElementById("edit-product-id").value;
      const product = {
        name: document.getElementById('edit-product-name').value,
        description: document.getElementById('edit-product-desc').value,
        price: document.getElementById('edit-product-price').value,
        imageUrl: document.getElementById('edit-product-image').value,
        category: { id: document.getElementById('edit-product-category').value }
      };
      const res = await fetch('/products/' + id + '?adminEmail=' + encodeURIComponent(adminEmail), {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(product)
      });
      if (res.ok) {
        alert('Product updated!');
        bootstrap.Modal.getOrCreateInstance(document.getElementById('editProductModal')).hide();
        loadProducts();
      } else {
        alert('Update failed: ' + await res.text());
      }
    });

    // Delete Product
    window.deleteProduct = async function(id) {
      if (!confirm('Are you sure you want to delete this product?')) return;
      const adminEmail = localStorage.getItem('adminEmail');
      const res = await fetch('/products/' + id + '?adminEmail=' + encodeURIComponent(adminEmail), {
        method: 'DELETE'
      });
      if (res.ok) {
        alert('Product deleted');
        loadProducts();
      } else {
        alert('Delete failed: ' + await res.text());
      }
    };

    window.onload = function () {
      renderNavbar();
      loadProducts();
      loadCategoriesToDropdown('product-category');
      
      // Search form submission
      const searchForm = document.getElementById('search-form');
      const searchInput = document.getElementById('search-input');
      
      if (searchForm) {
        searchForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const query = searchInput.value;
          loadProducts(query);
        });
      }
      
      // Optional: Real-time search
      if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            const query = this.value;
            if (query.length >= 1 || query.length === 0) {
              loadProducts(query);
            }
          }, 300);
        });
      }
    };
  </script>
</body>
</html>
